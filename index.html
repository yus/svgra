<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVGRA - Native SVG Editor</title>
    <style>
        /* ===== MOBILE-FIRST VERTICAL LAYOUT ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        /* Main App Container - Single Column */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full viewport height */
            width: 100vw; /* Full viewport width */
            max-width: 100%;
            background: white;
            overflow: hidden;
            position: relative;
        }

        /* Header - Fixed at Top */
        .app-header {
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 64px;
            flex-shrink: 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .app-header h1 {
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .app-header h1::before {
            content: 'üé®';
            font-size: 1.4rem;
        }

        /* Floating Menu */
        .floating-menu {
            position: relative;
            z-index: 1000;
        }

        .menu-toggle {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.25);
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            font-size: 1.8rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }

        /* Main Content - Vertical Split */
        .main-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            height: calc(100vh - 64px); /* Subtract header height */
        }

        /* Editor Panel - Top Half */
        .editor-panel {
            flex: 1;
            min-height: 50vh;
            max-height: 50vh;
            display: flex;
            flex-direction: column;
            border-bottom: 2px solid #e5e7eb;
            overflow: hidden;
            background: #f8fafc;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }

        .panel-header h2 {
            font-size: 1.1rem;
            color: #1f2937;
            font-weight: 600;
        }

        .status {
            font-size: 0.8rem;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
        }

        /* Editor Container */
        .editor-container {
            flex: 1;
            overflow: hidden;
            position: relative;
            background: #f8fafc;
        }

        #editor {
            width: 100%;
            height: 100%;
            padding: 16px;
            border: none;
            resize: none;
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace;
            font-size: 15px;
            line-height: 1.5;
            background: transparent;
            color: #1f2937;
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: auto;
            overflow-y: auto;
            tab-size: 2;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        #editor:focus {
            outline: none;
            background: white;
        }

        /* Preview Panel - Bottom Half */
        .preview-panel {
            flex: 1;
            min-height: 50vh;
            max-height: 50vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: white;
        }

        #preview {
            flex: 1;
            overflow: auto;
            padding: 20px;
            background: 
                linear-gradient(45deg, #f3f4f6 25%, transparent 25%),
                linear-gradient(-45deg, #f3f4f6 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #f3f4f6 75%),
                linear-gradient(-45deg, transparent 75%, #f3f4f6 75%);
            background-size: 24px 24px;
            background-position: 0 0, 0 12px, 12px -12px, -12px 0px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            position: relative;
        }

        /* ===== OVERFLOW HANDLING FOR PREVIEW ===== */
        #preview svg {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            display: block;
            margin: auto;
            overflow: visible !important; /* Force visible overflow */
        }

        /* Special handling for text elements */
        #preview text {
            overflow: visible !important;
            white-space: pre !important;
            dominant-baseline: middle !important;
        }

        /* ViewBox overlay adjustments */
        .viewbox-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            pointer-events: none;
            z-index: 10;
            overflow: visible !important;
        }

        .viewbox-indicator {
            position: absolute;
            border: 2px dashed rgba(239, 68, 68, 0.6);
            background: rgba(239, 68, 68, 0.05);
            box-sizing: border-box;
            overflow: visible !important;
        }

        .viewbox-label {
            position: absolute;
            font-size: 11px;
            color: #ef4444;
            background: white;
            padding: 3px 6px;
            border: 1px solid #ef4444;
            border-radius: 4px;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: visible !important;
            z-index: 20;
        }

        /* ===== MENU DROPDOWN (Mobile Optimized) ===== */
        .menu-dropdown {
            position: fixed;
            bottom: 80px;
            right: 16px;
            left: 16px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 70vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .menu-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .menu-item {
            width: 100%;
            padding: 16px 20px;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            color: #374151;
            font-size: 0.95rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
            border-bottom: 1px solid rgba(229, 231, 235, 0.5);
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            background: #f3f4f6;
        }

        .menu-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 8px 0;
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 3000;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transition: all 0.4s ease;
            max-width: 90%;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* ===== SCROLLBAR STYLING ===== */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(241, 241, 241, 0.5);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(193, 193, 193, 0.8);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(161, 161, 161, 0.8);
        }

        /* ===== TOUCH OPTIMIZATIONS ===== */
        @media (hover: none) and (pointer: coarse) {
            .menu-toggle {
                min-height: 48px;
                min-width: 48px;
            }
        
            .menu-item {
                min-height: 48px;
                padding: 18px 20px;
            }
        
            #editor {
                font-size: 16px; /* Larger text for mobile */
                padding: 20px;
            }
        }

        /* ===== DESKTOP ADAPTATIONS ===== */
        @media (min-width: 769px) {
            body {
                padding: 20px;
            }
        
            .app-container {
                height: calc(100vh - 40px);
                max-width: 1400px;
                margin: 0 auto;
                border-radius: 16px;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            }
        
            .main-content {
                flex-direction: row;
                height: calc(100vh - 104px); /* Adjust for larger header */
            }
        
            .editor-panel, .preview-panel {
                min-height: auto;
                max-height: none;
                flex: 1;
            }
        
            .editor-panel {
                border-right: 2px solid #e5e7eb;
                border-bottom: none;
            }
        
            .menu-dropdown {
                position: absolute;
                bottom: auto;
                top: calc(100% + 10px);
                right: 0;
                left: auto;
                min-width: 240px;
                max-height: 60vh;
            }
        
            .toast {
                left: auto;
                right: 20px;
                transform: translateX(0) translateY(20px);
            }
        
            .toast.show {
                transform: translateX(0) translateY(0);
            }
        }

        /* ===== LARGE SCREEN OPTIMIZATIONS ===== */
        @media (min-width: 1024px) {
            .app-header h1 {
                font-size: 1.6rem;
            }
        
            .panel-header h2 {
                font-size: 1.2rem;
            }
        
            #editor {
                font-size: 14px;
                padding: 24px;
            }
        
            #preview {
                padding: 30px;
            }
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            .app-header,
            .menu-toggle,
            .panel-header {
                display: none !important;
            }
        
            .app-container {
                height: auto;
                box-shadow: none;
            }
        
            .main-content {
                flex-direction: column;
                height: auto;
            }
        
            .editor-panel {
                display: none;
            }
        
            .preview-panel {
                min-height: auto;
                max-height: none;
            }
        
            #preview {
                background: white !important;
                padding: 0;
            }
        
            #preview svg {
                max-width: none;
                max-height: none;
                width: 100% !important;
                height: auto !important;
            }
        }

        /* ===== ACCESSIBILITY ===== */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            }
        
            .app-container {
                background: #1e293b;
                color: #e2e8f0;
            }
        
            .editor-panel {
                background: #0f172a;
            }
        
            #editor {
                background: #0f172a;
                color: #e2e8f0;
            }
        
            #preview {
                background: 
                    linear-gradient(45deg, #334155 25%, transparent 25%),
                    linear-gradient(-45deg, #334155 25%, transparent 25%),
                    linear-gradient(45deg, transparent 75%, #334155 75%),
                    linear-gradient(-45deg, transparent 75%, #334155 75%);
            }
        
            .menu-dropdown {
                background: #334155;
                color: #e2e8f0;
            }
        
            .menu-item {
                color: #e2e8f0;
            }
        
            .menu-item:hover {
                background: #475569;
            }
        }
        /* Stats Bar Styles */
.stats-bar {
    display: flex;
    justify-content: space-around;
    align-items: center;
    background: linear-gradient(90deg, #f8fafc, #ffffff);
    border-bottom: 1px solid #e5e7eb;
    padding: 8px 20px;
    font-family: 'SF Mono', 'Menlo', 'Monaco', monospace;
    font-size: 13px;
    color: #4b5563;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
}

.stat {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.7);
    border: 1px solid rgba(229, 231, 235, 0.5);
    transition: all 0.2s ease;
}

.stat:hover {
    background: white;
    border-color: #d1d5db;
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.stat-label {
    font-weight: 600;
    color: #6b7280;
}

.stat-value {
    font-weight: 700;
    color: #4f46e5;
    min-width: 40px;
    text-align: right;
}

/* Responsive adjustment */
@media (max-width: 768px) {
    .stats-bar {
        flex-wrap: wrap;
        gap: 8px;
        padding: 8px 12px;
    }
    
    .stat {
        flex: 1;
        min-width: calc(50% - 20px);
        justify-content: space-between;
    }
}
    </style>
    </head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <img src="svgra.svg" alt="logo" height="50" />
            <h1>Native SVG Editor</h1>
            <div class="floating-menu">
                <button class="menu-toggle" id="menuToggle">‚ãÆ</button>
                <div class="menu-dropdown" id="menuDropdown">
                    <button class="menu-item" id="saveSVG">
                        üíæ Save SVG File
                    </button>
                    <button class="menu-item" id="savePNG">
                        üñºÔ∏è Export as PNG
                    </button>
                    <button class="menu-item" id="copyCode">
                        üìã Copy SVG Code
                    </button>
                    <button class="menu-item" id="shareLink">
                        üîó Create Shareable Link
                    </button>
                    <button class="menu-item" id="loadExample">
                        üß™ Load Example
                    </button>
                    <div class="menu-divider"></div>
                    <button class="menu-item" id="toggleViewBox">
                        üìê Show ViewBox Overlay
                    </button>
                    <button class="menu-item" id="toggleGrid">
                        üü∞ Hide Background Grid
                    </button>
                </div>
            </div>
        </header>
        <!-- Add this right after </header> -->
<div class="stats-bar" id="statsBar">
    <div class="stat">
        <span class="stat-label">Elements:</span>
        <span class="stat-value" id="statElements">0</span>
    </div>
    <div class="stat">
        <span class="stat-label">Size:</span>
        <span class="stat-value" id="statSize">0 B</span>
    </div>
    <div class="stat">
        <span class="stat-label">Depth:</span>
        <span class="stat-value" id="statDepth">0</span>
    </div>
    <div class="stat">
        <span class="stat-label">Last Update:</span>
        <span class="stat-value" id="statUpdate">Just now</span>
    </div>
</div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Editor Panel -->
            <section class="editor-panel">
                <div class="panel-header">
                    <h2>SVG Code Editor</h2>
                    <span class="status" id="editorStatus">Ready</span>
                </div>
                <div class="editor-container">
                    <textarea id="editor" spellcheck="false" placeholder="Type your SVG code here..."></textarea>
                </div>
            </section>

            <!-- Preview Panel -->
            <section class="preview-panel">
                <div class="panel-header">
                    <h2>Live Preview</h2>
                    <span class="status" id="previewStatus">Valid SVG</span>
                </div>
                <div id="preview">
                    <!-- SVG will be rendered here -->
                </div>
            </section>
        </main>
    </div>

    <script>
        // ====== APP STATE ======
        const state = {
            showViewBoxOverlay: true,
            showBackgroundGrid: true,
            lastValidSVG: '',
            isEditorDirty: false
        };

        // ====== DOM ELEMENTS ======
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const menuToggle = document.getElementById('menuToggle');
        const menuDropdown = document.getElementById('menuDropdown');
        const editorStatus = document.getElementById('editorStatus');
        const previewStatus = document.getElementById('previewStatus');

        // ====== INITIAL SVG CONTENT ======
        const initialSVG = `<svg width="400" height="300" viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
  <!-- Welcome to SVGRA - Native SVG Editor -->
  <!-- Try editing this code and watch the preview update in real-time! -->
  
  <!-- Background rectangle with gradient -->
  <defs>
    <linearGradient id="bgGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#3b82f6" stop-opacity="0.1"/>
      <stop offset="100%" stop-color="#8b5cf6" stop-opacity="0.1"/>
    </linearGradient>
    
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="2" dy="4" stdDeviation="3" flood-color="#4f46e5" flood-opacity="0.3"/>
    </filter>
  </defs>
  
  <!-- ViewBox boundary (matches viewBox="0 0 400 300") -->
  <rect x="0" y="0" width="400" height="300" fill="url(#bgGradient)" stroke="#d1d5db" stroke-width="1" stroke-dasharray="5,5"/>
  
  <!-- Main design elements -->
  <rect x="50" y="50" width="300" height="200" rx="20" fill="white" stroke="#4f46e5" stroke-width="3" filter="url(#shadow)"/>
  
  <circle cx="200" cy="150" r="80" fill="#ef4444" opacity="0.8" filter="url(#shadow)"/>
  
  <polygon points="200,70 250,170 150,170" fill="#10b981" opacity="0.9" filter="url(#shadow)"/>
  
  <!-- Text elements -->
  <text x="200" y="260" text-anchor="middle" font-family="Arial, sans-serif" font-size="18" fill="#374151" font-weight="bold">
    SVGRA Editor
  </text>
  
  <text x="200" y="285" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="#6b7280">
    Edit code ‚Ä¢ See live preview ‚Ä¢ Export freely
  </text>
  
  <!-- Coordinate markers -->
  <circle cx="0" cy="0" r="4" fill="#ef4444"/>
  <text x="10" y="15" font-family="monospace" font-size="10" fill="#ef4444">(0,0)</text>
  
  <circle cx="400" cy="300" r="4" fill="#10b981"/>
  <text x="330" y="295" font-family="monospace" font-size="10" fill="#10b981">(400,300)</text>
</svg>`;

        // ====== INITIALIZATION ======
        function init() {
            // Set initial editor content
            editor.value = initialSVG;
            state.lastValidSVG = initialSVG;
            
            // Setup event listeners
            setupEventListeners();
            
            // Initial render
            renderPreview();
            
            // Load from URL if present
            loadFromURL();
            
            console.log('SVGRA Editor initialized successfully!');
        }

        // ====== EVENT LISTENERS ======
        function setupEventListeners() {
            // Editor input
            editor.addEventListener('input', function() {
                state.isEditorDirty = true;
                editorStatus.textContent = 'Editing...';
                editorStatus.style.color = '#f59e0b';
                renderPreview();
            });
            
            // Tab key support
            editor.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    const spaces = '  ';
                    this.value = this.value.substring(0, start) + spaces + this.value.substring(end);
                    this.selectionStart = this.selectionEnd = start + spaces.length;
                    renderPreview();
                }
            });
            
            // Menu toggle
            menuToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                menuDropdown.classList.toggle('show');
            });
            
            // Close menu when clicking outside
            document.addEventListener('click', function(e) {
                if (!menuToggle.contains(e.target) && !menuDropdown.contains(e.target)) {
                    menuDropdown.classList.remove('show');
                }
            });
            
            // Menu actions
            document.getElementById('saveSVG').addEventListener('click', saveSVG);
            document.getElementById('savePNG').addEventListener('click', exportPNG);
            document.getElementById('copyCode').addEventListener('click', copyCode);
            document.getElementById('shareLink').addEventListener('click', createShareLink);
            document.getElementById('loadExample').addEventListener('click', loadExample);
            document.getElementById('toggleViewBox').addEventListener('click', toggleViewBox);
            document.getElementById('toggleGrid').addEventListener('click', toggleGrid);
        }

        // ====== CORE RENDERING FUNCTION ======
        function renderPreview() {
            const svgCode = editor.value;
            
            // Clear preview
            preview.innerHTML = '';
            
            // Remove old viewBox overlay
            const oldOverlay = document.querySelector('.viewbox-overlay');
            if (oldOverlay) oldOverlay.remove();
            
            try {
                // Parse SVG
                const parser = new DOMParser();
                const svgDoc = parser.parseFromString(svgCode, 'image/svg+xml');
                
                // Check for parsing errors
                const error = svgDoc.querySelector('parsererror');
                if (error) {
                    preview.innerHTML = `<div style="color: #ef4444; padding: 20px; font-family: monospace; background: #fef2f2; border-radius: 8px;">
                        <strong>XML Error:</strong><br>${error.textContent}
                    </div>`;
                    previewStatus.textContent = 'Invalid XML';
                    previewStatus.style.color = '#ef4444';
                    return;
                }
                
                const svgElement = svgDoc.documentElement;
                if (!svgElement || svgElement.nodeName !== 'svg') {
                    throw new Error('Root element must be <svg>');
                }
                
                // Import and render SVG
                const importedSvg = document.importNode(svgElement, true);
                preview.appendChild(importedSvg);
                
                // Store valid SVG
                state.lastValidSVG = svgCode;
                state.isEditorDirty = false;
                
                // Update status
                editorStatus.textContent = 'Valid SVG';
                editorStatus.style.color = '#10b981';
                previewStatus.textContent = 'Rendered';
                previewStatus.style.color = '#10b981';
                
                // Add viewBox overlay if enabled
                if (state.showViewBoxOverlay) {
                    addViewBoxOverlay(importedSvg);
                }
                
                // Make elements interactive
                makeInteractive(importedSvg);
                
            } catch (err) {
                preview.innerHTML = `<div style="color: #ef4444; padding: 20px; font-family: monospace; background: #fef2f2; border-radius: 8px;">
                    <strong>Rendering Error:</strong><br>${err.message}
                </div>`;
                previewStatus.textContent = 'Error';
                previewStatus.style.color = '#ef4444';
            }
        }

        // ====== VIEWBOX OVERLAY ======
        function addViewBoxOverlay(svgElement) {
            const viewBox = svgElement.getAttribute('viewBox');
            if (!viewBox) return;
            
            const [x, y, width, height] = viewBox.split(' ').map(parseFloat);
            const svgRect = preview.getBoundingClientRect();
            const svgInnerRect = svgElement.getBoundingClientRect();
            
            // Calculate scale and position
            const scaleX = svgInnerRect.width / width;
            const scaleY = svgInnerRect.height / height;
            const offsetX = (svgRect.width - svgInnerRect.width) / 2;
            const offsetY = (svgRect.height - svgInnerRect.height) / 2;
            
            // Create overlay container
            const overlay = document.createElement('div');
            overlay.className = 'viewbox-overlay';
            overlay.style.width = `${svgRect.width}px`;
            overlay.style.height = `${svgRect.height}px`;
            
            // Create viewBox indicator
            const indicator = document.createElement('div');
            indicator.className = 'viewbox-indicator';
            indicator.style.left = `${offsetX}px`;
            indicator.style.top = `${offsetY}px`;
            indicator.style.width = `${svgInnerRect.width}px`;
            indicator.style.height = `${svgInnerRect.height}px`;
            
            // Create label
            const label = document.createElement('div');
            label.className = 'viewbox-label';
            label.textContent = `viewBox="${viewBox}"`;
            label.style.left = `${offsetX + 10}px`;
            label.style.top = `${offsetY - 30}px`;
            
            overlay.appendChild(indicator);
            overlay.appendChild(label);
            preview.appendChild(overlay);
        }

        // ====== INTERACTIVE FEATURES ======
        function makeInteractive(svgElement) {
            // Add click handlers to all elements
            const elements = svgElement.querySelectorAll('*');
            elements.forEach(el => {
                el.style.cursor = 'pointer';
                el.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectElement(this);
                });
            });
            
            // Add click handler to SVG root for deselection
            svgElement.addEventListener('click', function(e) {
                if (e.target === this) {
                    clearSelection();
                }
            });
        }
        
        function selectElement(element) {
            // Remove previous selection
            clearSelection();
            
            // Highlight selected element
            element.style.outline = '2px solid #4f46e5';
            element.style.outlineOffset = '2px';
            
            // Show toast with element info
            const tag = element.tagName.toLowerCase();
            const id = element.id ? `#${element.id}` : '';
            showToast(`Selected: &lt;${tag}${id}&gt;`, 'info');
        }
        
        function clearSelection() {
            const selected = preview.querySelector('[style*="outline: 2px solid"]');
            if (selected) {
                selected.style.outline = '';
            }
        }

        // ====== MENU ACTIONS ======
        function saveSVG() {
            const svgCode = editor.value;
            const blob = new Blob([svgCode], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `svgra-design-${Date.now()}.svg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('üíæ SVG saved successfully!');
            menuDropdown.classList.remove('show');
        }
        
        function exportPNG() {
            const svgElement = preview.querySelector('svg');
            if (!svgElement) {
                showToast('No SVG to export', 'error');
                return;
            }
            
            const svgData = new XMLSerializer().serializeToString(svgElement);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Set canvas dimensions
                canvas.width = img.width;
                canvas.height = img.height;
                
                // Draw white background
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw SVG
                ctx.drawImage(img, 0, 0);
                
                // Create download link
                const pngUrl = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = pngUrl;
                a.download = `svgra-export-${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                showToast('üñºÔ∏è PNG exported successfully!');
            };
            
            img.onerror = function() {
                showToast('Failed to export PNG', 'error');
            };
            
            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
            menuDropdown.classList.remove('show');
        }
        
        function copyCode() {
            navigator.clipboard.writeText(editor.value)
                .then(() => showToast('üìã SVG code copied to clipboard!'))
                .catch(() => showToast('Failed to copy', 'error'));
            menuDropdown.classList.remove('show');
        }
        
        function createShareLink() {
            const svgCode = encodeURIComponent(editor.value);
            const currentUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${currentUrl}?svg=${svgCode}`;
            
            // Try to use Web Share API first
            if (navigator.share) {
                navigator.share({
                    title: 'My SVG Design',
                    text: 'Check out this SVG design I made with SVGRA!',
                    url: shareUrl
                });
            } else {
                // Fallback to clipboard
                navigator.clipboard.writeText(shareUrl)
                    .then(() => showToast('üîó Shareable link copied to clipboard!'))
                    .catch(() => showToast('Failed to copy link', 'error'));
            }
            menuDropdown.classList.remove('show');
        }
        
        function loadExample() {
            editor.value = initialSVG;
            renderPreview();
            showToast('üß™ Example loaded!');
            menuDropdown.classList.remove('show');
        }
        
        function toggleViewBox() {
            state.showViewBoxOverlay = !state.showViewBoxOverlay;
            const btn = document.getElementById('toggleViewBox');
            btn.innerHTML = state.showViewBoxOverlay ? 
                'üìê Hide ViewBox Overlay' : 'üìê Show ViewBox Overlay';
            renderPreview();
            menuDropdown.classList.remove('show');
        }
        
        function toggleGrid() {
            state.showBackgroundGrid = !state.showBackgroundGrid;
            const btn = document.getElementById('toggleGrid');
            btn.innerHTML = state.showBackgroundGrid ? 
                'üü∞ Hide Background Grid' : 'üü∞ Show Background Grid';
            
            if (state.showBackgroundGrid) {
                preview.style.background = `
                    linear-gradient(45deg, #f3f4f6 25%, transparent 25%),
                    linear-gradient(-45deg, #f3f4f6 25%, transparent 25%),
                    linear-gradient(45deg, transparent 75%, #f3f4f6 75%),
                    linear-gradient(-45deg, transparent 75%, #f3f4f6 75%)
                `;
                preview.style.backgroundSize = '24px 24px';
                preview.style.backgroundPosition = '0 0, 0 12px, 12px -12px, -12px 0px';
            } else {
                preview.style.background = '#ffffff';
            }
            menuDropdown.classList.remove('show');
        }

        // ====== URL LOADING ======
        function loadFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const svgParam = urlParams.get('svg');
            
            if (svgParam) {
                try {
                    const decodedSVG = decodeURIComponent(svgParam);
                    editor.value = decodedSVG;
                    renderPreview();
                    showToast('üìÇ Loaded from URL', 'info');
                } catch (err) {
                    showToast('Failed to load from URL', 'error');
                }
            }
        }

        // ====== TOAST NOTIFICATIONS ======
        function showToast(message, type = 'success') {
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            
            // Create new toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = message;
            
            // Add icon based on type
            let icon = '‚úÖ';
            if (type === 'error') icon = '‚ùå';
            if (type === 'warning') icon = '‚ö†Ô∏è';
            if (type === 'info') icon = '‚ÑπÔ∏è';
            
            toast.innerHTML = `${icon} ${message}`;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Remove after delay
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        document.body.removeChild(toast);
                    }
                }, 400);
            }, 3000);
        }
        // Add this function to calculate and update stats
function updateStatsBar() {
    try {
        const svgCode = editor.value;
        
        // Calculate element count
        const parser = new DOMParser();
        const svgDoc = parser.parseFromString(svgCode, 'image/svg+xml');
        const allElements = svgDoc.querySelectorAll('*');
        const elementCount = allElements.length;
        
        // Calculate file size
        const codeSize = new Blob([svgCode]).size;
        const sizeText = codeSize < 1024 ? 
            `${codeSize} B` : 
            `${(codeSize / 1024).toFixed(1)} KB`;
        
        // Calculate max nesting depth
        const root = svgDoc.documentElement;
        let maxDepth = 0;
        
        function getDepth(node, currentDepth) {
            if (node.children.length === 0) return currentDepth;
            let maxChildDepth = currentDepth;
            for (const child of node.children) {
                maxChildDepth = Math.max(maxChildDepth, getDepth(child, currentDepth + 1));
            }
            return maxChildDepth;
        }
        
        if (root && root.tagName === 'svg') {
            maxDepth = getDepth(root, 0);
        }
        
        // Update the DOM elements
        document.getElementById('statElements').textContent = elementCount;
        document.getElementById('statSize').textContent = sizeText;
        document.getElementById('statDepth').textContent = maxDepth;
        document.getElementById('statUpdate').textContent = 'Just now';
        
        // Add a timestamp reset after 2 seconds
        clearTimeout(window.statsTimer);
        window.statsTimer = setTimeout(() => {
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            document.getElementById('statUpdate').textContent = timeStr;
        }, 2000);
        
    } catch (error) {
        // Silent fail - don't break the app if stats can't be calculated
        console.debug('Stats calculation skipped:', error.message);
    }
}

// Connect to editor input (add this with your other event listeners)
editor.addEventListener('input', updateStatsBar);

// Initialize on first load
document.addEventListener('DOMContentLoaded', function() {
    // Wait a moment for editor to be ready
    setTimeout(updateStatsBar, 100);
});

        // ====== INITIALIZE APP ======
        // Set up beforeunload warning
        window.addEventListener('beforeunload', function(e) {
            if (state.isEditorDirty) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            }
        });

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
